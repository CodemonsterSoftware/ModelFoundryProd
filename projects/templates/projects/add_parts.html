{% extends 'projects/base.html' %}
{% load crispy_forms_tags %}

{% block title %}Add Parts - {{ project.name }}{% endblock %}

{% block extra_css %}
<style>
.table-fixed {
    table-layout: fixed;
}
.editable-cell {
    padding: 0 !important;
}
.editable-input {
    width: 100%;
    height: 100%;
    border: none;
    padding: 8px;
    background: transparent;
    color: var(--text-light) !important;
}
.editable-input:focus {
    outline: 2px solid #0d6efd;
    background: var(--bg-grey);
    color: var(--text-light) !important;
}
.editable-select {
    width: 100%;
    height: 100%;
    border: none;
    padding: 8px;
    background: transparent;
    color: var(--text-light) !important;
}
.editable-select:focus {
    background: var(--bg-grey);
    color: var(--text-light) !important;
}
.color-input {
    width: 100%;
    height: 36px;
    padding: 2px;
    border: none;
    background: transparent;
}
.table-hover tbody tr:hover {
    background-color: var(--bg-grey) !important;
}
.sticky-header {
    position: sticky;
    top: 0;
    background: white;
    z-index: 1;
}
.upload-area {
    border: 2px dashed #404040;
    border-radius: 5px;
    padding: 20px;
    text-align: center;
    background: #2d2d2d;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 15px;
    min-height: 200px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
.upload-area:hover {
    border-color: #0d6efd;
    background: #333333;
}
.upload-area.dragover {
    border-color: #0d6efd;
    background: #333333;
    box-shadow: 0 0 10px rgba(13, 110, 253, 0.3);
}
.form-label {
    color: #e0e0e0 !important;
}
.form-control {
    background-color: #2d2d2d !important;
    border-color: #404040 !important;
    color: #e0e0e0 !important;
}
.form-control:focus {
    background-color: #2d2d2d !important;
    border-color: #404040 !important;
    color: #e0e0e0 !important;
}
.form-select {
    background-color: #2d2d2d !important;
    border-color: #404040 !important;
    color: #e0e0e0 !important;
}
.form-select:focus {
    background-color: #2d2d2d !important;
    border-color: #404040 !important;
    color: #e0e0e0 !important;
}
.card {
    background-color: #2d2d2d !important;
    border-color: #404040 !important;
}
.card-header {
    background-color: #333333 !important;
    border-bottom-color: #404040 !important;
    color: #e0e0e0 !important;
}
.table {
    color: var(--text-light) !important;
}
.table th {
    background-color: var(--bg-grey) !important;
    border-color: var(--border-dark) !important;
    color: var(--text-light) !important;
}
.table td {
    background-color: var(--bg-darker) !important;
    border-color: var(--border-dark) !important;
    color: var(--text-light) !important;
}
.table-hover tbody tr:hover {
    background-color: var(--bg-grey) !important;
}
.upload-progress-modal {
    z-index: 1060;
}
.upload-progress-modal .modal-content {
    background-color: var(--bg-darker) !important;
    border-color: var(--border-dark) !important;
}
.upload-progress-modal .modal-header {
    background-color: var(--bg-grey) !important;
    border-bottom-color: var(--border-dark) !important;
    color: var(--text-light) !important;
}
.upload-progress-modal .modal-body {
    background-color: var(--bg-darker) !important;
    color: var(--text-light) !important;
}
.upload-progress-modal .progress {
    height: 30px;
    background-color: var(--bg-grey);
    border-radius: 5px;
}
.upload-progress-modal .progress-bar {
    background-color: var(--primary-color);
    transition: width 0.3s ease;
}
.upload-stats {
    display: flex;
    justify-content: space-between;
    margin-top: 15px;
    font-size: 0.9rem;
    color: var(--text-muted);
}
.upload-stats span {
    color: var(--text-light);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    {% csrf_token %}
    <div class="row mb-4">
        <div class="col">
            <h1>Add Parts</h1>
            <p class="text-muted">Add multiple parts to {{ project.name }}</p>
        </div>
        <div class="col text-end">
            <a href="{% url 'projects:project_detail' project.pk %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Project
            </a>
        </div>
    </div>

    <!-- Store materials data for JavaScript -->
    <script>
        const materialsData = [
            {% for material in materials %}
            {
                id: "{{ material.id }}",
                name: "{{ material.name }}",
                color: "{{ material.color|default:'#000000' }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
    </script>

    <div class="card mb-4">
        <div class="card-body">
            <div class="upload-area" id="uploadArea">
                <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
                <h5>Drag and drop STL files here</h5>
                <p class="text-muted">or click to browse</p>
                <input type="file" id="fileInput" multiple accept=".stl" style="display: none;">
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-light">
            <div class="row align-items-center">
                <div class="col-auto">
                    <button type="button" class="btn btn-success" id="saveAll">
                        <i class="fas fa-save"></i> Save All
                    </button>
                </div>
                <div class="col-auto">
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-secondary" id="copyDown">
                            <i class="fas fa-arrow-down"></i> Copy Down
                        </button>
                        <button type="button" class="btn btn-outline-danger" id="deleteSelected">
                            <i class="fas fa-trash"></i> Delete Selected
                        </button>
                    </div>
                </div>
                <div class="col-auto">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAll">
                        <label class="form-check-label" for="selectAll">Select All</label>
                    </div>
                </div>
                <div class="col-auto ms-auto">
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newGroupModal">
                        <i class="fas fa-plus"></i> New Group
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-fixed mb-0" id="partsTable">
                    <thead class="sticky-header">
                        <tr>
                            <th style="width: 40px;"><i class="fas fa-check"></i></th>
                            <th style="width: 250px;">Name</th>
                            <th style="width: 100px;">Quantity</th>
                            <th style="width: 150px;">Material</th>
                            <th style="width: 100px;">Color</th>
                            <th style="width: 150px;">Group</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Upload Progress Modal -->
<div class="modal fade upload-progress-modal" id="uploadProgressModal" tabindex="-1" aria-labelledby="uploadProgressModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadProgressModalLabel">
                    <i class="fas fa-upload me-2"></i>Uploading Parts
                </h5>
            </div>
            <div class="modal-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" 
                         id="uploadProgressBar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        <span id="uploadProgressText">0%</span>
                    </div>
                </div>
                <div class="upload-stats">
                    <div>
                        <span id="uploadedSize">0 KB</span> / <span id="totalSize">0 KB</span>
                    </div>
                    <div>
                        <span id="uploadSpeed">0 KB/s</span>
                    </div>
                    <div>
                        <span id="timeRemaining">Calculating...</span>
                    </div>
                </div>
                <div class="mt-3 text-center">
                    <small class="text-muted" id="uploadStatus">Preparing upload...</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Group Modal -->
<div class="modal fade" id="newGroupModal" tabindex="-1" aria-labelledby="newGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newGroupModalLabel">Create New Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="newGroupForm">
                    <div class="mb-3">
                        <label for="groupName" class="form-label">Group Name</label>
                        <input type="text" class="form-control" id="groupName" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="createGroup">Create Group</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    const $uploadArea = $('#uploadArea');
    const $fileInput = $('#fileInput');
    const $table = $('#partsTable');
    let rowCount = 0;
    
    // Handle click on upload area
    $uploadArea.on('click', function(e) {
        e.preventDefault();
        $fileInput.trigger('click');
    });
    
    // Handle file selection
    $fileInput.on('change', function(e) {
        handleFiles(e.target.files);
    });
    
    // Handle drag and drop
    $uploadArea.on('dragover', function(e) {
        e.preventDefault();
        $(this).addClass('dragover');
    });
    
    $uploadArea.on('dragleave', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
    });
    
    $uploadArea.on('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
        handleFiles(e.originalEvent.dataTransfer.files);
    });
    
    // Function to handle uploaded files
    function handleFiles(files) {
        Array.from(files).forEach(file => {
            if (file.name.toLowerCase().endsWith('.stl')) {
                addRowFromFile(file);
            }
        });
    }
    
    // Function to add a new row from a file
    function addRowFromFile(file) {
        // Create a new row from the template structure
        const $newRow = $('<tr class="part-row">').attr('data-id', `new-${rowCount}`);
        $newRow.html(`
            <td class="text-center">
                <input type="checkbox" class="row-select">
            </td>
            <td class="editable-cell">
                <input type="text" class="editable-input" name="name" placeholder="Part name">
            </td>
            <td class="editable-cell">
                <input type="number" class="editable-input" name="quantity" value="1" min="1">
            </td>
            <td class="editable-cell">
                <select class="editable-select" name="material">
                    <option value="">Select Material</option>
                    ${materialsData.map(material => `
                        <option value="${material.id}" data-color="${material.color}">
                            ${material.name}
                        </option>
                    `).join('')}
                </select>
            </td>
            <td class="editable-cell">
                <input type="color" class="color-input" name="color" value="#000000">
            </td>
            <td class="editable-cell">
                <select class="editable-select" name="group">
                    <option value="">No Group</option>
                    {% for group in groups %}
                        <option value="{{ group.id }}">{{ group.name }}</option>
                    {% endfor %}
                </select>
            </td>
        `);
        
        // Set the filename as the part name (without extension)
        const fileName = file.name.replace(/\.stl$/i, '');
        $newRow.find('[name="name"]').val(fileName);
        
        // Add file data attribute
        $newRow.data('file', file);
        
        $table.find('tbody').append($newRow);
        rowCount++;

        // Add event listener for material selection
        $newRow.find('[name="material"]').change(function() {
            const selectedOption = $(this).find('option:selected');
            const color = selectedOption.data('color');
            if (color) {
                $newRow.find('[name="color"]').val(color);
            }
        });
    }

    // Select all rows
    $('#selectAll').change(function() {
        const isChecked = $(this).prop('checked');
        $table.find('.row-select').prop('checked', isChecked);
    });

    // Copy down values
    $('#copyDown').click(function() {
        const $selectedRows = $table.find('.row-select:checked').closest('tr');
        if ($selectedRows.length === 0) return;

        const $firstRow = $selectedRows.first();
        const values = {
            material: $firstRow.find('[name="material"]').val(),
            color: $firstRow.find('[name="color"]').val(),
            group: $firstRow.find('[name="group"]').val()
        };

        $selectedRows.each(function() {
            $(this).find('[name="material"]').val(values.material);
            $(this).find('[name="color"]').val(values.color);
            $(this).find('[name="group"]').val(values.group);
        });
    });

    // Delete selected rows
    $('#deleteSelected').click(function() {
        if ($table.find('tbody tr').length > 1) {
            $table.find('.row-select:checked').closest('tr').remove();
        }
    });

    // Helper function to format bytes
    function formatBytes(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Helper function to format time
    function formatTime(seconds) {
        if (seconds < 60) {
            return Math.round(seconds) + 's';
        } else if (seconds < 3600) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.round(seconds % 60);
            return mins + 'm ' + secs + 's';
        } else {
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            return hours + 'h ' + mins + 'm';
        }
    }

    // Save all parts
    $('#saveAll').click(function() {
        const formData = new FormData();
        const parts = [];
        let totalSize = 0;
        
        $table.find('tbody tr').each(function() {
            const $row = $(this);
            const file = $row.data('file');
            
            if (file) {
                formData.append('files', file);
                totalSize += file.size;
            }
            
            const partData = {
                name: $row.find('[name="name"]').val(),
                quantity: parseInt($row.find('[name="quantity"]').val()),
                material: $row.find('[name="material"]').val(),
                color: $row.find('[name="color"]').val(),
                group: $row.find('[name="group"]').val()
            };

            // Validate required fields
            if (!partData.name) {
                alert('Please enter a name for all parts');
                return false;
            }
            if (isNaN(partData.quantity) || partData.quantity < 1) {
                alert('Please enter a valid quantity (minimum 1) for all parts');
                return false;
            }
            if (!partData.material) {
                alert('Please select a material for all parts');
                return false;
            }

            parts.push(partData);
        });

        if (parts.length === 0) {
            alert('Please add at least one part');
            return false;
        }

        formData.append('parts', JSON.stringify(parts));

        // Show loading state
        const $btn = $(this);
        const originalHtml = $btn.html();
        $btn.html('<i class="fas fa-spinner fa-spin"></i> Saving...').prop('disabled', true);

        // Initialize progress tracking variables
        let uploadedBytes = 0;
        let startTime = Date.now();
        let lastUpdateTime = startTime;
        let lastUploadedBytes = 0;
        let speedSamples = [];
        const maxSamples = 10;
        
        // Phase tracking: Upload (0-80%) and Processing (80-100%)
        const UPLOAD_PHASE_MAX = 80;
        const PROCESSING_PHASE_MAX = 100;
        
        // Estimate processing time based on file sizes
        // Rough estimate: ~0.5-2 seconds per MB depending on complexity
        // Base time: 0.5s per file + 1s per MB
        const fileCount = $table.find('tbody tr').length;
        const estimatedProcessingTime = Math.max(
            fileCount * 0.5, // Base time per file
            (totalSize / (1024 * 1024)) * 1.0 // 1 second per MB
        );

        // Show progress modal
        const progressModal = new bootstrap.Modal(document.getElementById('uploadProgressModal'));
        progressModal.show();

        // Initialize progress display
        $('#uploadProgressBar').css('width', '0%').attr('aria-valuenow', 0);
        $('#uploadProgressText').text('0%');
        $('#uploadedSize').text('0 Bytes');
        $('#totalSize').text(formatBytes(totalSize));
        $('#uploadSpeed').text('0 Bytes/s');
        $('#timeRemaining').text('Calculating...');
        $('#uploadStatus').text('Starting upload...');

        // Send AJAX request with progress tracking
        $.ajax({
            url: '{% url "projects:add_multiple_parts" project.pk %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
            },
            xhr: function() {
                const xhr = new window.XMLHttpRequest();
                
                // Upload progress
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        uploadedBytes = e.loaded;
                        const uploadPercent = (e.loaded / e.total) * 100;
                        // Map upload progress to 0-80% of total progress
                        const totalPercent = Math.round((uploadPercent / 100) * UPLOAD_PHASE_MAX);
                        
                        // Update progress bar
                        $('#uploadProgressBar').css('width', totalPercent + '%').attr('aria-valuenow', totalPercent);
                        $('#uploadProgressText').text(totalPercent + '%');
                        $('#uploadedSize').text(formatBytes(e.loaded));
                        $('#totalSize').text(formatBytes(e.total));
                        
                        // Calculate speed
                        const currentTime = Date.now();
                        const timeDiff = (currentTime - lastUpdateTime) / 1000; // seconds
                        
                        if (timeDiff > 0.1) { // Update every 100ms minimum
                            const bytesDiff = e.loaded - lastUploadedBytes;
                            const currentSpeed = bytesDiff / timeDiff; // bytes per second
                            
                            // Add to samples array
                            speedSamples.push(currentSpeed);
                            if (speedSamples.length > maxSamples) {
                                speedSamples.shift();
                            }
                            
                            // Calculate average speed
                            const avgSpeed = speedSamples.reduce((a, b) => a + b, 0) / speedSamples.length;
                            $('#uploadSpeed').text(formatBytes(avgSpeed) + '/s');
                            
                            // Calculate estimated time remaining for upload
                            const remainingBytes = e.total - e.loaded;
                            let uploadTimeRemaining = 0;
                            if (avgSpeed > 0) {
                                uploadTimeRemaining = remainingBytes / avgSpeed;
                            }
                            
                            // Add estimated processing time
                            const totalTimeRemaining = uploadTimeRemaining + estimatedProcessingTime;
                            $('#timeRemaining').text(formatTime(totalTimeRemaining));
                            
                            lastUpdateTime = currentTime;
                            lastUploadedBytes = e.loaded;
                        }
                        
                        // Update status
                        $('#uploadStatus').text(`Uploading ${fileCount} file${fileCount !== 1 ? 's' : ''}...`);
                    }
                }, false);
                
                return xhr;
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Upload complete, now processing
                    // Update to processing phase (80-100%)
                    let processingProgress = UPLOAD_PHASE_MAX;
                    $('#uploadProgressBar').css('width', processingProgress + '%').attr('aria-valuenow', processingProgress);
                    $('#uploadProgressText').text(processingProgress + '%');
                    $('#uploadStatus').text('Processing files and calculating volumes...');
                    $('#uploadSpeed').text('Processing...');
                    
                    // Use actual processing time from server, or fall back to estimate
                    const actualProcessingTime = response.processing_time || estimatedProcessingTime;
                    const processingStartTime = Date.now();
                    const processingRange = PROCESSING_PHASE_MAX - UPLOAD_PHASE_MAX; // 20%
                    
                    // Animate processing progress
                    const processingInterval = setInterval(function() {
                        const elapsed = (Date.now() - processingStartTime) / 1000;
                        const processingPercent = Math.min(1, elapsed / actualProcessingTime);
                        processingProgress = Math.round(UPLOAD_PHASE_MAX + (processingPercent * processingRange));
                        
                        $('#uploadProgressBar').css('width', processingProgress + '%').attr('aria-valuenow', processingProgress);
                        $('#uploadProgressText').text(processingProgress + '%');
                        
                        const remaining = Math.max(0, actualProcessingTime - elapsed);
                        $('#timeRemaining').text(formatTime(remaining));
                        
                        if (processingProgress >= PROCESSING_PHASE_MAX) {
                            clearInterval(processingInterval);
                            // Complete
                            $('#uploadProgressBar').css('width', '100%').attr('aria-valuenow', 100);
                            $('#uploadProgressText').text('100%');
                            $('#uploadStatus').text('Upload complete! Redirecting...');
                            $('#timeRemaining').text('0s');
                            setTimeout(function() {
                                window.location.href = '{% url "projects:project_detail" project.pk %}';
                            }, 500);
                        }
                    }, 100);
                    
                    // Safety timeout in case processing takes longer than expected
                    setTimeout(function() {
                        clearInterval(processingInterval);
                        if (processingProgress < PROCESSING_PHASE_MAX) {
                            $('#uploadProgressBar').css('width', '100%').attr('aria-valuenow', 100);
                            $('#uploadProgressText').text('100%');
                            $('#uploadStatus').text('Upload complete! Redirecting...');
                            $('#timeRemaining').text('0s');
                            setTimeout(function() {
                                window.location.href = '{% url "projects:project_detail" project.pk %}';
                            }, 500);
                        }
                    }, (actualProcessingTime * 1000) + 2000); // Add 2 second buffer
                } else {
                    progressModal.hide();
                    alert('Error: ' + (response.message || 'Unknown error occurred'));
                    $btn.html(originalHtml).prop('disabled', false);
                }
            },
            error: function(xhr) {
                progressModal.hide();
                let errorMessage = 'Error saving parts. Please try again.';
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.message) {
                        errorMessage = response.message;
                    }
                } catch (e) {
                    // If we can't parse the error message, use the default
                }
                alert(errorMessage);
                $btn.html(originalHtml).prop('disabled', false);
            }
        });
    });

    // Keyboard navigation
    $table.on('keydown', '.editable-input, .editable-select', function(e) {
        const $current = $(this);
        const $currentCell = $current.closest('td');
        const $currentRow = $current.closest('tr');
        
        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                const $nextRow = $currentRow.next('tr');
                if ($nextRow.length) {
                    $nextRow.find(`[name="${$current.attr('name')}"]`).focus();
                }
                break;
            case 'ArrowUp':
                e.preventDefault();
                const $prevRow = $currentRow.prev('tr');
                if ($prevRow.length) {
                    $prevRow.find(`[name="${$current.attr('name')}"]`).focus();
                }
                break;
        }
    });

    // Handle new group creation
    $('#createGroup').click(function() {
        const groupName = $('#groupName').val().trim();
        if (!groupName) {
            alert('Please enter a group name');
            return;
        }

        const $btn = $(this);
        const originalHtml = $btn.html();
        $btn.html('<i class="fas fa-spinner fa-spin"></i> Creating...').prop('disabled', true);

        $.ajax({
            url: '{% url "projects:add_group" project.pk %}',
            type: 'POST',
            data: {
                name: groupName,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Add the new group to all group selectors
                    const $newOption = $('<option>')
                        .val(response.group_id)
                        .text(groupName);
                    
                    $('select[name="group"]').each(function() {
                        $(this).append($newOption.clone());
                    });

                    // Close the modal and reset the form
                    $('#newGroupModal').modal('hide');
                    $('#newGroupForm')[0].reset();
                } else {
                    alert('Error: ' + (response.message || 'Failed to create group'));
                }
            },
            error: function(xhr) {
                alert('Error creating group. Please try again.');
            },
            complete: function() {
                $btn.html(originalHtml).prop('disabled', false);
            }
        });
    });

    // Reset form when modal is closed
    $('#newGroupModal').on('hidden.bs.modal', function() {
        $('#newGroupForm')[0].reset();
    });
});
</script>
{% endblock %} 