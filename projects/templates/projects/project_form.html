{% extends 'projects/base.html' %}
{% load crispy_forms_tags %}

{% block title %}{% if form.instance.pk %}Edit{% else %}Create{% endif %} Project - ModelFoundry{% endblock %}

{% block extra_css %}
<style>
    .form-label {
        color: #e0e0e0 !important;
    }
    .form-control {
        background-color: #2d2d2d !important;
        border-color: #404040 !important;
        color: #e0e0e0 !important;
    }
    .form-control:focus {
        background-color: #2d2d2d !important;
        border-color: #404040 !important;
        color: #e0e0e0 !important;
    }
    .form-select {
        background-color: #2d2d2d !important;
        border-color: #404040 !important;
        color: #e0e0e0 !important;
    }
    .form-select:focus {
        background-color: #2d2d2d !important;
        border-color: #404040 !important;
        color: #e0e0e0 !important;
    }
    .upload-area {
        border: 2px dashed #404040;
        border-radius: 5px;
        padding: 20px;
        text-align: center;
        background: #2d2d2d;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 15px;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .upload-area:hover {
        border-color: #0d6efd;
        background: #333333;
    }
    .upload-area.dragover {
        border-color: #0d6efd;
        background: #333333;
        box-shadow: 0 0 10px rgba(13, 110, 253, 0.3);
    }
    .image-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
    }
    .preview-item {
        position: relative;
        width: 150px;
        height: 150px;
        border-radius: 5px;
        overflow: hidden;
    }
    .preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .preview-item .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <h2 class="mb-4">{% if form.instance.pk %}Edit{% else %}Create{% endif %} Project</h2>
                    <form method="post" enctype="multipart/form-data" id="projectForm">
                        {% csrf_token %}
                        {{ form.name|as_crispy_field }}
                        {{ form.description|as_crispy_field }}
                        {{ form.designer|as_crispy_field }}
                        
                        <div class="form-group">
                            <label class="form-label">Project Images</label>
                            <div class="upload-area" id="uploadArea">
                                <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
                                <h5>Drag and drop images here</h5>
                                <p class="text-muted">or click to browse</p>
                                <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
                            </div>
                            <div class="image-preview" id="imagePreview"></div>
                        </div>

                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Save Project
                            </button>
                            <a href="{% url 'projects:project_list' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                            {% if form.instance.pk %}
                            <a href="{% url 'projects:project_delete' form.instance.pk %}" class="btn btn-danger float-end">
                                <i class="fas fa-trash me-2"></i>Delete Project
                            </a>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    const $uploadArea = $('#uploadArea');
    const $fileInput = $('#fileInput');
    const $imagePreview = $('#imagePreview');
    let files = [];

    // Get CSRF token from cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Handle click on upload area
    $uploadArea.on('click', function(e) {
        if (e.target === this) {
            $fileInput.click();
        }
    });

    // Handle file input change
    $fileInput.on('change', function(e) {
        const newFiles = Array.from(e.target.files);
        files = [...files, ...newFiles];
        updatePreview();
        // Reset the file input
        this.value = '';
    });

    // Handle drag and drop
    $uploadArea.on('dragover', function(e) {
        e.preventDefault();
        $(this).addClass('dragover');
    });

    $uploadArea.on('dragleave', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
    });

    $uploadArea.on('drop', function(e) {
        e.preventDefault();
        $(this).removeClass('dragover');
        const droppedFiles = Array.from(e.originalEvent.dataTransfer.files);
        files = [...files, ...droppedFiles];
        updatePreview();
    });

    function updatePreview() {
        $imagePreview.empty();
        
        files.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const $previewItem = $(`
                    <div class="preview-item">
                        <img src="${e.target.result}" alt="Preview">
                        <button type="button" class="remove-btn" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `);
                
                $imagePreview.append($previewItem);
            };
            reader.readAsDataURL(file);
        });
    }
    
    // Handle remove button clicks
    $imagePreview.on('click', '.remove-btn', function(e) {
        e.stopPropagation();
        const index = $(this).data('index');
        files.splice(index, 1);
        updatePreview();
    });
    
    // Handle form submission
    $('#projectForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        // Add each file to the FormData
        files.forEach((file, index) => {
            formData.append(`image_${index}`, file);
        });
        
        // Show loading state
        const $submitBtn = $(this).find('button[type="submit"]');
        const originalHtml = $submitBtn.html();
        $submitBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...').prop('disabled', true);
        
        // Submit the form
        $.ajax({
            url: window.location.href,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            },
            success: function(response) {
                if (response.status === 'success') {
                    window.location.href = response.redirect_url;
                } else {
                    alert('Error saving project. Please try again.');
                    $submitBtn.html(originalHtml).prop('disabled', false);
                }
            },
            error: function(xhr, status, error) {
                let errorMessage = 'Error saving project. Please try again.';
                try {
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    } else if (xhr.responseText) {
                        const response = JSON.parse(xhr.responseText);
                        if (response.message) {
                            errorMessage = response.message;
                        }
                    }
                } catch (e) {
                    console.error('Error parsing response:', e);
                }
                console.error('AJAX Error:', status, error);
                alert(errorMessage);
                $submitBtn.html(originalHtml).prop('disabled', false);
            }
        });
    });
});
</script>
{% endblock %} 